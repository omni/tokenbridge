---
- name: Register files for copying
  shell: |
    git ls-tree -r HEAD --name-only | sed '/^contracts$/d'
    cd contracts; git ls-tree -r HEAD --name-only | sed -e 's/^/contracts\//'
  register: registered_files
  delegate_to: 127.0.0.1
  become: false
  args:
    chdir: "{{ lookup('env', 'PWD') }}/.."

- name: Create repo directory structure
  file: 
    path: "{{ (bridge_path + '/' + item) }}"
    state: directory
    recurse: yes
  with_items: "{{ registered_files.stdout_lines | map('dirname') | list | unique }}"

- name: Copy the files
  copy:
    src: ../../../../{{ item }}
    dest: "{{ bridge_path }}/{{ item }}"
  with_items: "{{ registered_files.stdout_lines }}"

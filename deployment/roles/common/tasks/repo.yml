---
- name: Create repo directory
  file: 
    path: "{{ bridge_path }}"
    state: directory

- name: Register files for copying
  shell: |
    git ls-tree -r HEAD --name-only
    cd contracts; git ls-tree -r HEAD --name-only | sed -e 's/^/contracts\//'
  register: rsync_files
  delegate_to: 127.0.0.1
  become: false
  args:
    chdir: ".."

- name: Copy the files
  synchronize:
    dest: "{{ bridge_path }}"
    src: ../../../..
    rsync_opts:
      - "--include=\"{{ item }}\""
      - "--exclude='*'"
      - "-avz"
  with_items: rsync_files.stdout_lines
